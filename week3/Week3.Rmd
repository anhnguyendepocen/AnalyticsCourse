---
title: 'Week 3: SQL Introduction'
author: "Ted Laderas"
date: "June 9, 2016"
output: html_notebook
---

```{r echo=FALSE, warning=FALSE, message=FALSE}
```

This week we will be loading our data into a database type called SQLite. SQLite is a database engine that's open-source and is widely used. We'll use it to simulate our data warehouse that we will calculate our analytics on. Loading into a database system will also let us produce more complicated queries that join the different tables in our dataset. 

If you have not done last week's assignment, please do it now. You need to at least have downloaded the synthetic data set and made an RStudio project for that folder.

## Installing the SQLite Package

The first thing you need to do is install the RSQLite package into R. This package contains the SQLite engine and will let you interact with SQLite databases directly.

```{r eval=FALSE}
install.packages("RSQLite")
```

Now that you have the RSQLite package, you need to load it up with the `library()` command. Note that you will have to do this each time you want to use the package.

```{r warning=FALSE}
library(RSQLite)
library(here)
library(tidyverse)
#start our connection to the database
con <- DBI::dbConnect(RSQLite::SQLite(), here("data/patient1.sqlite"))
```

## Running a Simple Query

Let's start to use SQL (Structured Query Language). SQL is the language for searching and manipulating data in databases. Writing good SQL queries will always be a useful skill no matter what field you decide to go into.

Let's ask a simple question about the `patient` table. How many female patients are there? There are two ways we can do this. The first would be to select those patients that are female with a `SELECT` statement, return those patients as a `data.frame`, and then just count the number of rows in the `data.frame`.

Here we use another form of the `tbl()` function. The `src` (source) argument is our connection, but our `from` argument is our SQL.

```{r}
# SQL to return all columns from patient table
# where Gender is female
sqlStatement <- "SELECT * from patient WHERE Gender == 'Female'"

femalePatients <- tbl(src=con, from=sql(sqlStatement))

femalePatients <- collect(femalePatients)

nrow(femalePatients)
```

Or, we can combine our statement with `count` statement from above and get the answer directly.

```{r}
#note that for matching strings, we have to use single quotes in our SQL
#statement. Otherwise, R gets confused where the statement begins or ends.
sqlStatement <- "SELECT COUNT(*) FROM patient WHERE Gender == 'Female'"

numberFemalePatients <- tbl(src=con, from=sql(sqlStatement))

numberFemalePatients
```

If we wanted the number of Female patients with a normal `riskCat`, we can chain these queries using `AND`.:

```{r}
#Again, enclosing strings within single quotes so we don't confuse R
sqlStatement <- 
  "SELECT count(*) FROM patient WHERE GENDER == 'Female' 
                  AND riskCat == 'Normal'"

numberFemaleNormalPatients <- tbl(con, sql(sqlStatement))

numberFemaleNormalPatients
```

If we only wanted a few columns from the table (such as `patientid`, `GENDER` and `riskCat`), we can change our select statement to only return these columns:

```{r}
sqlStatement <- "SELECT patientid, GENDER, riskCat FROM patient 
            WHERE GENDER == 'Female' AND riskCat == 'Normal'"

selectResults <- dbGetQuery(SQLiteConnection, sqlStatement)

selectResults[1:10,]
```

## Assignment 3

Please refer to `week3Submission.Rmd` for this week's assignment.

##For More Information

Please refer to [R-Bootcamp Module 5](https://github.com/laderast/r-bootcamp/tree/master/module5) for more information on databases and SQLite.
