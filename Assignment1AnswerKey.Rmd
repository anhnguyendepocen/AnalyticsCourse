---
title: 'Assignment #1 Answer Key'
author: "Ted Laderas"
date: "August 17, 2016"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Please refer to the Amarasingham Appendix on how to calculate the LACE Score before reading this.

## Calculating Length of Stay (L)

Building on our analytic table from yesterday, we want to first calculate length of stay. We can do this by using `julianday()`. Then we recode it as the L score by using `CASE` statements. We also only want to select the index cases, because the readmits are irrelevant.

```{r cars}
#load the RSQLite library
library(RSQLite)

#initialize a database connection (and initialize our database)
con <- dbConnect(SQLite(),dbname="patient2.sqlite")

sqlStatement <- "SELECT analytic.*, julianday(Discharge_date) - julianday(Admit_date) 
        as LengthOfStay from analytic WHERE indexadmit = 1"

analytic2 <- dbGetQuery(con, sqlStatement)
#confirm that we have calculated length of stay correctly
analytic2[1:10,]

dbRemoveTable(con, "analytic")
dbWriteTable(con, "analytic", analytic2)
```

Now we can recode `LengthOfStay` into the L score.

```{r}
sqlStatement <- "select analytic.*, CASE WHEN LengthOfStay = 1 THEN 1
                 WHEN LengthOfStay = 2 THEN 2
                 WHEN LengthOfStay = 3 THEN 3
                 WHEN LengthOfStay >= 4 AND LengthOfStay <= 6 THEN 4
                 WHEN LengthOfStay >= 7 AND LengthOfSTay <= 13 THEN 5
                 WHEN LengthOfStay >= 14 THEN 6
                 ELSE 0 END as LScore from analytic"

analytic3 <- dbGetQuery(con, sqlStatement)
#confirm that we have calculated length of stay correctly
analytic3[1:10,]

dbRemoveTable(con, "analytic")
dbWriteTable(con, "analytic", analytic3)
```

## Calculating A

A is simply whether the index case had an `Admit_source` of "Emergency Room". We code a value of 3 if TRUE, a value of 0 if not.

```{r}
sqlStatement <- "SELECT analytic.*, CASE WHEN Admit_source == 'Emergency Room' 
                 THEN 3 ELSE 0 END as AScore from analytic"

analytic4 <- dbGetQuery(con, sqlStatement)
analytic4[1:10,]

dbRemoveTable(con, "analytic")
dbWriteTable(con, "analytic", analytic4)
```

## Calculating E

E is trickier. We need to identify any emergency room encounters from `patient_encounter` that happened before the index case and count them. We know that encounter type `48` equals emergency room visits, so we can use that in our filtering criteria for the case statement. We wrap this in a subquery so we can then use `SUM` and `GROUP BY` to sum these ED visits. Because our score maxes out at 4, we need to use a `CASE` statement to make the score 4 if the number of visits is 4 or higher. 

We could have also used a more selective `WHERE` statement instead of using the `CASE` statement within the subquery and just used `COUNT` as our aggregating function.

```{r}
sqlStatement <- "SELECT patientID, 
                CASE WHEN SUM(EDvisits) < 4 THEN SUM(EDvisits) 
                ELSE 4 END as EScore
                FROM
                (SELECT pe.*, 
                CASE WHEN pe.encounter_type = 48 THEN 1 ELSE 0 END as EDvisits 
                from analytic, patient_encounter as pe 
                WHERE pe.patientID = analytic.patientid and 
                date(pe.Actual_Date) < date(analytic.Admit_date))
                GROUP BY (patientID)"

peCases <- dbGetQuery(con, sqlStatement)
#confirm that we have calculated number of visits
dbWriteTable(con, "EDvisits", peCases)
peCases[1:30,]
```

Now that we have our `EDvisits` table, we can now join `EDvisits` with our analytic table.

```{r}
sqlStatement <- "SELECT a.*, e.EScore FROM analytic as a, EDvisits as e
                 WHERE a.patientID = e.patientID"

analytic5 <- dbGetQuery(con, sqlStatement)
dbRemoveTable(con, "analytic")
dbWriteTable(con, "analytic", analytic5)

#save our results
dbDisconnect(con)
```

Doing a summary, we can confirm that everything we have done is correct (our scores are within the expected range).

```{r}
summary(analytic5)
```